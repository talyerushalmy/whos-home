<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{% block title %}Who's Home{% endblock %}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <style>
        .device-card {
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .device-online {
            border-left-color: #28a745;
            background-color: #f8fff9;
        }
        
        .device-offline {
            border-left-color: #dc3545;
            background-color: #fff8f8;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        
        .status-online {
            background-color: #28a745;
            box-shadow: 0 0 8px rgba(40, 167, 69, 0.4);
        }
        
        .status-offline {
            background-color: #dc3545;
        }
        
        .navbar-brand {
            font-weight: bold;
        }
        
        .color-preview {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            border: 2px solid #fff;
            box-shadow: 0 0 4px rgba(0,0,0,0.2);
        }
        
        .last-seen {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .discovery-spinner {
            display: none;
        }
        
        .settings-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }
    </style>
    
    {% block extra_head %}{% endblock %}
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-house-door"></i> Who's Home
            </a>
            
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/tv" target="_blank">
                    <i class="bi bi-tv"></i> TV Display
                </a>
                <a class="nav-link" href="#" onclick="showSettings()">
                    <i class="bi bi-gear"></i> Settings
                </a>
                <a class="nav-link" href="/logout">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mt-4">
        {% block content %}{% endblock %}
    </main>

    <!-- Settings Modal -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Settings</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="settingsForm">
                        <div class="settings-section">
                            <h6 class="mb-3">Discovery Settings</h6>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Scan Interval (seconds)</label>
                                    <input type="number" class="form-control" id="scan_interval" min="10" max="300" value="30">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Network Range</label>
                                    <input type="text" class="form-control" id="network_range" placeholder="192.168.1.0/24">
                                    <div class="form-text">Use 'auto' for automatic detection</div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Ping Timeout (seconds)</label>
                                    <input type="number" class="form-control" id="ping_timeout" min="1" max="10" step="0.1" value="1">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">ARP Timeout (seconds)</label>
                                    <input type="number" class="form-control" id="arping_timeout" min="1" max="10" step="0.1" value="2">
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Discovery Methods</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="method_ping" value="ping" checked>
                                    <label class="form-check-label" for="method_ping">
                                        Ping (ICMP)
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="method_arping" value="arping" checked>
                                    <label class="form-check-label" for="method_arping">
                                        ARP Ping
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="settings-section">
                            <h6 class="mb-3">TV Display Settings</h6>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="tv_display_public" checked>
                                    <label class="form-check-label" for="tv_display_public">
                                        <strong>Public TV Display Access</strong>
                                    </label>
                                    <div class="form-text">
                                        When enabled, anyone can access the TV display without logging in. 
                                        When disabled, authentication is required to view the TV display.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Device Discovery Modal -->
    <div class="modal fade" id="discoveryModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Discover Devices</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4 discovery-spinner">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Scanning...</span>
                        </div>
                        <p class="mt-2">Scanning network for devices...</p>
                    </div>
                    
                    <div id="discoveredDevices" class="row">
                        <!-- Discovered devices will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="discoverDevices()">
                        <i class="bi bi-arrow-clockwise"></i> Scan Again
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Device Modal -->
    <div class="modal fade" id="editDeviceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Device</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editDeviceForm">
                        <input type="hidden" id="editMacAddress" />
                        
                        <div class="mb-3">
                            <label for="editNickname" class="form-label">Device Nickname</label>
                            <input type="text" class="form-control" id="editNickname" required>
                            <div class="form-text">Choose a friendly name for this device</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editColor" class="form-label">Color</label>
                            <div class="row">
                                <div class="col-8">
                                    <input type="color" class="form-control form-control-color" id="editColor" value="#007bff">
                                </div>
                                <div class="col-4">
                                    <div class="color-preview-large" id="editColorPreview" style="width: 100%; height: 38px; border-radius: 4px; border: 1px solid #ddd; background-color: #007bff;"></div>
                                </div>
                            </div>
                            <div class="form-text">This color will identify the device in the dashboard</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="editImage" class="form-label">Device Picture</label>
                            <div class="row">
                                <div class="col-8">
                                    <input type="file" class="form-control" id="editImage" accept="image/*">
                                    <div class="form-text">Upload a picture for this device (optional)</div>
                                    <button type="button" class="btn btn-sm btn-outline-danger mt-2" id="removeImageBtn" onclick="removePicture()" style="display: none;">
                                        <i class="bi bi-trash"></i> Remove Picture
                                    </button>
                                </div>
                                <div class="col-4">
                                    <div class="text-center">
                                        <img id="editImagePreview" src="" alt="Preview" style="max-width: 60px; max-height: 60px; border-radius: 50%; border: 2px solid #ddd; display: none;">
                                        <div id="editImagePlaceholder" style="width: 60px; height: 60px; border-radius: 50%; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; font-size: 24px; margin: 0 auto;">👤</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">MAC Address</label>
                            <input type="text" class="form-control" id="editMacAddressDisplay" readonly>
                            <div class="form-text">MAC address cannot be changed</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveDeviceEdit()">
                        <i class="bi bi-check-lg"></i> Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variables
        let socket;
        let currentSettings = {};
        
        // Initialize Socket.IO connection
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', function() {
                console.log('Connected to server');
            });
            
            socket.on('disconnect', function() {
                console.log('Disconnected from server');
            });
            
            socket.on('device_updates', function(data) {
                updateDeviceStatus(data.devices);
            });
        }
        
        // Load settings
        function loadSettings() {
            fetch('/api/settings')
                .then(response => response.json())
                .then(data => {
                    currentSettings = data.settings;
                    populateSettingsForm();
                })
                .catch(error => console.error('Error loading settings:', error));
        }
        
        // Populate settings form
        function populateSettingsForm() {
            document.getElementById('scan_interval').value = currentSettings.scan_interval || 30;
            document.getElementById('network_range').value = currentSettings.network_range || '192.168.1.0/24';
            document.getElementById('ping_timeout').value = currentSettings.ping_timeout || 1;
            document.getElementById('arping_timeout').value = currentSettings.arping_timeout || 2;
            
            const methods = currentSettings.discovery_methods || ['ping', 'arping'];
            document.getElementById('method_ping').checked = methods.includes('ping');
            document.getElementById('method_arping').checked = methods.includes('arping');
            
            // TV display accessibility setting
            const tvDisplayPublic = currentSettings.tv_display_public;
            if (typeof tvDisplayPublic === 'string') {
                document.getElementById('tv_display_public').checked = tvDisplayPublic.toLowerCase() === 'true';
            } else {
                document.getElementById('tv_display_public').checked = tvDisplayPublic !== false;
            }
        }
        
        // Show settings modal
        function showSettings() {
            loadSettings();
            const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
            modal.show();
        }
        
        // Save settings
        function saveSettings() {
            const methods = [];
            if (document.getElementById('method_ping').checked) methods.push('ping');
            if (document.getElementById('method_arping').checked) methods.push('arping');
            
            const settings = {
                scan_interval: parseInt(document.getElementById('scan_interval').value),
                network_range: document.getElementById('network_range').value,
                ping_timeout: parseFloat(document.getElementById('ping_timeout').value),
                arping_timeout: parseFloat(document.getElementById('arping_timeout').value),
                discovery_methods: methods,
                tv_display_public: document.getElementById('tv_display_public').checked
            };
            
            fetch('/api/settings', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
                    showToast('Settings saved successfully', 'success');
                } else {
                    showToast('Error saving settings', 'error');
                }
            })
            .catch(error => {
                console.error('Error saving settings:', error);
                showToast('Error saving settings', 'error');
            });
        }
        
        // Show discovery modal
        function showDiscovery() {
            const modal = new bootstrap.Modal(document.getElementById('discoveryModal'));
            modal.show();
            discoverDevices();
        }
        
        // Discover devices
        function discoverDevices() {
            document.querySelector('.discovery-spinner').style.display = 'block';
            document.getElementById('discoveredDevices').innerHTML = '';
            
            fetch('/api/discover')
                .then(response => response.json())
                .then(data => {
                    document.querySelector('.discovery-spinner').style.display = 'none';
                    displayDiscoveredDevices(data.devices);
                })
                .catch(error => {
                    console.error('Error discovering devices:', error);
                    document.querySelector('.discovery-spinner').style.display = 'none';
                    showToast('Error discovering devices', 'error');
                });
        }
        
        // Show toast notification
        function showToast(message, type = 'info') {
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'error' ? 'danger' : 'success'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            const toastElement = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
            
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }
        
        // Create toast container if it doesn't exist
        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'position-fixed top-0 end-0 p-3';
            container.style.zIndex = '9999';
            document.body.appendChild(container);
            return container;
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Color picker preview update
            const editColorInput = document.getElementById('editColor');
            const editColorPreview = document.getElementById('editColorPreview');
            
            if (editColorInput && editColorPreview) {
                editColorInput.addEventListener('input', function() {
                    editColorPreview.style.backgroundColor = this.value;
                });
            }
            
            // Handle image preview
            const editImageInput = document.getElementById('editImage');
            if (editImageInput) {
                editImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    const preview = document.getElementById('editImagePreview');
                    const placeholder = document.getElementById('editImagePlaceholder');
                    const removeBtn = document.getElementById('removeImageBtn');
                    
                    // Clear the remove flag when a new file is selected
                    this.removeAttribute('data-remove-image');
                    
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            preview.src = e.target.result;
                            preview.style.display = 'block';
                            placeholder.style.display = 'none';
                            removeBtn.style.display = 'inline-block';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        preview.style.display = 'none';
                        placeholder.style.display = 'flex';
                        removeBtn.style.display = 'none';
                    }
                });
            }
            
            {% block page_init %}{% endblock %}
        });
    </script>
    
    {% block extra_scripts %}{% endblock %}
</body>
</html>
